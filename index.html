<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/style.css">
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <style>
    body,
    html {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      height: calc(100% - 70px);
    }

    .toolbar {
      font-size: 16px;
      height: 70px;
      padding: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12);
    }

    .btn {
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #888;
      background: #f7f7f7;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn.primary {
      background: #007bff;
      color: #fff;
      border-color: #0069d9;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .coords {
      font-size: 14px;
    }

    .flex-right {
      margin-left: auto;
      display: flex;
      gap: 6px;
    }

    .mo-mp {
      color: red;
      align-items: center;
      display: flex;
      text-align: center;
    }

    dialog {
      border: 0;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.25);
      max-width: 420px;
      width: 85%;
      text-align: center;
      background: #fff;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: fadeIn 0.4s ease;
    }

    dialog::backdrop {
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(3px);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -55%);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    dialog h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #ccc;
    }

    #stepsContainer img {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 0.75rem;
    }
  </style>
</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

  <div class="toolbar">
    <div class="coords" id="coords">Lat: ‚Äî , Lng: ‚Äî </div>
    <div class="mo-mp">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</div>
    <div class="flex-right">
      <button class="btn primary" id="sendBtn">‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á</button>
    </div>
  </div>

  <div id="map"></div>

  <!-- üß≠ Modal ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
  <dialog id="guideModal">
    <h2>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>

    <div id="stepsContainer">
      <img id="stepImage">
      <!-- <p id="stepText">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</p>-->
    </div>

    <!--<div style="margin-top:1rem;display:flex;justify-content:space-between;">
      <button class="btn" id="prevStep" disabled>‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <button class="btn primary" id="nextStep">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>-->

    <button class="btn primary" id="closeGuide" style="display:none;margin-top:1rem;">‡∏õ‡∏¥‡∏î</button>
  </dialog>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // üìç ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏°‡∏û
    const qs = (name, fallback) => new URL(location.href).searchParams.get(name) || fallback;

    const defaultLat = parseFloat(qs('lat', '16.48014010030842'));
    const defaultLng = parseFloat(qs('lng', '99.54879500429345'));
    const map = L.map('map').setView([defaultLat, defaultLng], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);
    const coordsEl = document.getElementById('coords');

    function updateCoords(latlng) {
      coordsEl.textContent = `Lat: ${latlng.lat.toFixed(6)} , Lng: ${latlng.lng.toFixed(6)}`;
    }
    updateCoords(marker.getLatLng());

    marker.on('dragend', () => updateCoords(marker.getLatLng()));
    map.on('click', e => { marker.setLatLng(e.latlng); updateCoords(e.latlng); });

    document.getElementById('sendBtn').onclick = async () => {
      const ll = marker.getLatLng();
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('s');
      const payload = {
        lat: ll.lat,
        lng: ll.lng,
        ts: new Date().toISOString(),
        userId: userId
      };

      const webhookUrl = 'https://cctv-test.cctv-bot.site/webhook/88ddaf7c-06a8-41b8-9a06-a966ded108ac';

      try {
        const resp = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        alert(resp.ok ? '‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!' : '‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } catch {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞ CORS)');
      }
    };

    // ü™Ñ ‡∏£‡∏∞‡∏ö‡∏ö modal ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    // üìñ ‡∏ä‡∏∏‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    const steps = [
      { img: "1.png", text: "1Ô∏è‚É£ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°" },
      { img: "2.png", text: "2Ô∏è‚É£ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£" },
      { img: "3.png", text: "3Ô∏è‚É£ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‚Äù" },
      { img: "4.png", text: "4Ô∏è‚É£ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" },
      { img: "5.png", text: "5Ô∏è‚É£ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" }
    ];

    // üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ modal
    const modal = document.getElementById('guideModal');
    const modalImg = document.createElement('img');
    const modalText = document.createElement('p');
    const nextBtn = document.createElement('button');
    const closeBtn = document.createElement('button');

    // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
    modalImg.style.width = '100%';
    modalImg.style.borderRadius = '10px';
    modalText.style.marginTop = '10px';

    const btnBase = `
    margin-top: 15px;
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 15px;
  `;

    nextBtn.style = btnBase + 'background:#007bff;color:white;';
    closeBtn.style = btnBase + 'background:#6c757d;color:white;display:none;';

    nextBtn.textContent = '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
    closeBtn.textContent = '‡∏õ‡∏¥‡∏î';

    modal.appendChild(modalImg);
    modal.appendChild(modalText);
    modal.appendChild(nextBtn);
    modal.appendChild(closeBtn);

    let currentStep = 0;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô
    function showStep(index) {
      const step = steps[index];
      modalImg.src = step.img;
      modalText.textContent = step.text;

      // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°
      if (index === steps.length - 1) {
        nextBtn.style.display = 'none';
        closeBtn.style.display = 'inline-block';
      } else {
        nextBtn.style.display = 'inline-block';
        closeBtn.style.display = 'none';
      }
    }

    // ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‚Äù
    nextBtn.onclick = () => {
      if (currentStep < steps.length - 1) {
        currentStep++;
        showStep(currentStep);
      }
    };

    // ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏õ‡∏¥‡∏î‚Äù
    closeBtn.onclick = () => {
      modal.close();
    };

    // ‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
    window.onload = () => {
      currentStep = 0;
      showStep(currentStep);
      modal.showModal();
    };
  </script>
</body>

</html>