<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/style.css">
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <style>
    body,
    html {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      height: calc(100% - 70px);
    }

    .toolbar {
      font-size: 16px;
      height: 70px;
      padding: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12);
    }

    .btn {
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #888;
      background: #f7f7f7;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn.primary {
      background: #007bff;
      color: #fff;
      border-color: #0069d9;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .coords {
      font-size: 14px;
    }

    .flex-right {
      margin-left: auto;
      display: flex;
      gap: 6px;
    }

    .mo-mp {
      color: red;
      align-items: center;
      display: flex;
      text-align: center;
    }

    dialog {
      border: 0;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.25);
      max-width: 420px;
      width: 85%;
      text-align: center;
      background: #fff;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: fadeIn 0.4s ease;
    }

    dialog::backdrop {
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(3px);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -55%);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    dialog h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #ccc;
    }

    #stepsContainer img {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 0.75rem;
    }
  </style>
</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

  <div class="toolbar">
    <div class="coords" id="coords">Lat: ‚Äî , Lng: ‚Äî </div>
    <div class="mo-mp">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</div>
    <div class="flex-right">
      <button class="btn primary" id="sendBtn">‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á</button>
    </div>
  </div>

  <div id="map"></div>

  <!-- üß≠ Modal ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
  <dialog id="guideModal">
    <h2>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>

    <div id="stepsContainer">
      <img id="stepImage" src="https://via.placeholder.com/400x200?text=‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà+1">
      <p id="stepText">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</p>
    </div>

    <div style="margin-top:1rem;display:flex;justify-content:space-between;">
      <button class="btn" id="prevStep" disabled>‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <button class="btn primary" id="nextStep">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>

    <button class="btn primary" id="closeGuide" style="display:none;margin-top:1rem;">‡∏õ‡∏¥‡∏î</button>
  </dialog>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // üìç ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏°‡∏û
    const qs = (name, fallback) => new URL(location.href).searchParams.get(name) || fallback;

    const defaultLat = parseFloat(qs('lat', '16.48014010030842'));
    const defaultLng = parseFloat(qs('lng', '99.54879500429345'));
    const map = L.map('map').setView([defaultLat, defaultLng], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);
    const coordsEl = document.getElementById('coords');

    function updateCoords(latlng) {
      coordsEl.textContent = `Lat: ${latlng.lat.toFixed(6)} , Lng: ${latlng.lng.toFixed(6)}`;
    }
    updateCoords(marker.getLatLng());

    marker.on('dragend', () => updateCoords(marker.getLatLng()));
    map.on('click', e => { marker.setLatLng(e.latlng); updateCoords(e.latlng); });

    document.getElementById('sendBtn').onclick = async () => {
      const ll = marker.getLatLng();
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('s');
      const payload = {
        lat: ll.lat,
        lng: ll.lng,
        ts: new Date().toISOString(),
        userId: userId
      };

      const webhookUrl = 'https://cctv-test.cctv-bot.site/webhook/88ddaf7c-06a8-41b8-9a06-a966ded108ac';

      try {
        const resp = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        alert(resp.ok ? '‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!' : '‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } catch {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞ CORS)');
      }
    };

    // ü™Ñ ‡∏£‡∏∞‡∏ö‡∏ö modal ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    const steps = [
      {
        img: "https://via.placeholder.com/400x200?text=‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà+1",
        text: "1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°"
      },
      {
        img: "https://via.placeholder.com/400x200?text=‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà+2",
        text: "2. ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£"
      },
      {
        img: "https://via.placeholder.com/400x200?text=‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà+3",
        text: "3. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
      }
    ];

    const modal = document.getElementById('guideModal');
    const stepImage = document.getElementById('stepImage');
    const stepText = document.getElementById('stepText');
    const nextBtn = document.getElementById('nextStep');
    const prevBtn = document.getElementById('prevStep');
    const closeBtn = document.getElementById('closeGuide');

    let currentStep = 0;

    function showStep(index) {
      stepImage.src = steps[index].img;
      stepText.textContent = steps[index].text;
      prevBtn.disabled = index === 0;
      nextBtn.style.display = index === steps.length - 1 ? "none" : "inline-block";
      closeBtn.style.display = index === steps.length - 1 ? "inline-block" : "none";
    }

    nextBtn.addEventListener('click', () => {
      if (currentStep < steps.length - 1) {
        currentStep++;
        showStep(currentStep);
      }
    });

    prevBtn.addEventListener('click', () => {
      if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
      }
    });

    closeBtn.addEventListener('click', () => {
      modal.close();
    });

    // ‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    window.addEventListener('DOMContentLoaded', () => {
      modal.showModal();
      showStep(currentStep);
    });
  </script>
</body>

</html>
